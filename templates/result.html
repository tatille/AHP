<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kết quả AHP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
    <h1>AHP App</h1>
    <a href="/" class="{% if request.path == '/' %}active{% endif %}">Bước 1: Số lượng</a>
    <a href="/step2" class="{% if request.path == '/step2' %}active{% endif %}">Bước 2: Nhập tên</a>
    <a href="/step3" class="{% if request.path == '/step3' %}active{% endif %}">Bước 3: Ma trận</a>
    <a href="/step4" class="{% if request.path == '/step4' %}active{% endif %}">Bước 4: Ma trận</a>
    <a href="/result" class="{% if request.path == '/result' %}active{% endif %}">Kết quả</a>
    <a href="/history" class="{% if request.path == '/history' %}active{% endif %}">Xem lịch sử</a>
  </div>

  <div class="main-content">
    <h2>Kết quả AHP</h2>

    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}

    {% if result %}
      <p><b>Chỉ số nhất quán (CR):</b> {{ result.CR }}</p>

      <h3>Trọng số tiêu chí:</h3>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Tiêu chí</th>
            <th>Trọng số</th>
          </tr>
        </thead>
        <tbody>
          {% for criterion, weight in result.weights.items() %}
          <tr>
            <td>{{ criterion }}</td>
            <td>{{ weight }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <h3>Xếp hạng phương án:</h3>
      <div style="max-width: 500px; margin: 0 auto 2rem auto;">
        <canvas id="pieChart"></canvas>
      </div>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Phương án</th>
            <th>Điểm</th>
          </tr>
        </thead>
        <tbody>
          {% for alternative, score in result.ranked_alternatives %}
          <tr>
            <td>{{ alternative }}</td>
            <td>{{ score }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const pieLabels = {{ result.ranked_alternatives | map(attribute=0) | list | tojson }};
          const pieData = {{ result.ranked_alternatives | map(attribute=1) | list | tojson }};
          const pieColors = [
            '#0D706E', '#F9A825', '#43A047', '#E53935', '#3949AB', '#8E24AA', '#00838F', '#F4511E', '#6D4C41', '#757575'
          ];
          new Chart(document.getElementById('pieChart'), {
            type: 'pie',
            data: {
              labels: pieLabels,
              datasets: [{
                data: pieData,
                backgroundColor: pieColors.slice(0, pieLabels.length)
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'Tỉ lệ xếp hạng phương án' }
              }
            }
          });
        });
      </script>
    {% endif %}

    <div class="buttons">
      <a href="/">← Quay lại trang chính</a>
      <a href="/history">Xem lịch sử</a>
      <a href="/export_excel" class="btn btn-success">Xuất kết quả ra Excel</a>
    </div>
  </div>
</body>
</html>
